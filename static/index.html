<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perplexity-2API æ§åˆ¶å°</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-radius: 10px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .active { background-color: #28a745; }
        .inactive { background-color: #dc3545; }
        .api-box { background: #2d3436; color: #fff; padding: 10px; border-radius: 5px; font-family: monospace; }
        .log-container { max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .log-line { padding: 2px 5px; border-bottom: 1px solid #eee; }
        .log-line.info { color: #0d6efd; }
        .log-line.success { color: #198754; }
        .log-line.warning { color: #ffc107; }
        .log-line.error { color: #dc3545; }
        .log-line.debug { color: #6c757d; }

        .progress-bar-custom { height: 8px; }
    </style>
    <script>
        // ä¿®å¤éè¢«åŠ¨äº‹ä»¶ç›‘å¬å™¨è­¦å‘Šï¼ˆæå‡é¡µé¢å“åº”é€Ÿåº¦ï¼‰
        (function() {
            var addEventListener = EventTarget.prototype.addEventListener;
            EventTarget.prototype.addEventListener = function(type, listener, options) {
                var passiveOptions = options;
                // ä¸ºæ»šåŠ¨ç›¸å…³äº‹ä»¶è‡ªåŠ¨æ·»åŠ  passive: true
                if (type === 'mousewheel' || type === 'wheel' || type === 'touchstart' || type === 'touchmove') {
                    if (typeof options === 'object') {
                        passiveOptions = Object.assign({ passive: true }, options);
                    } else if (options === undefined) {
                        passiveOptions = { passive: true };
                    } else if (options === false) {
                        passiveOptions = { passive: false };
                    }
                }
                return addEventListener.call(this, type, listener, passiveOptions);
            };
        })();
    </script>
</head>
<body>
    <div class="container-fluid py-3">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4 rounded">
            <div class="container-fluid">
                <a class="navbar-brand fw-bold text-primary" href="#">
                    <i class="fas fa-robot me-2"></i>âš¡ Perplexity-2API æ§åˆ¶å°
                </a>
                <div class="d-flex">
                    <span class="badge bg-dark me-2">v3.0</span>
                    <div class="d-flex align-items-center">
                        <span class="me-2" id="systemStatus">ğŸŸ¢ ç³»ç»Ÿè¿è¡Œæ­£å¸¸</span>
                        <div class="spinner-border spinner-border-sm text-primary d-none" id="loadingSpinner"></div>
                    </div>
                </div>
            </div>
        </nav>

        <div class="row g-3">
            <!-- å·¦ä¾§ä¾§è¾¹æ  -->
            <div class="col-lg-3">
                <!-- ç³»ç»ŸçŠ¶æ€é¢æ¿ -->
                <div class="card p-3 mb-3">
                    <h6 class="card-title fw-bold"><i class="fas fa-heartbeat me-2"></i>ç³»ç»ŸçŠ¶æ€</h6>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">æœåŠ¡çŠ¶æ€:</small>
                            <span class="badge bg-success" id="serviceStatus">è¿è¡Œä¸­</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">Botasaurus:</small>
                            <span class="badge bg-warning" id="botasaurusStatus">åˆå§‹åŒ–ä¸­</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">è´¦å·æ± :</small>
                            <span id="accountPoolStatus">0/0</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">APIè¯·æ±‚:</small>
                            <span id="apiRequestCount">0</span>
                        </div>
                    </div>
                    <div class="progress mb-1 progress-bar-custom">
                        <div class="progress-bar bg-info" id="memoryUsage" style="width: 30%"></div>
                    </div>
                    <small class="text-muted d-block text-center">å†…å­˜ä½¿ç”¨: <span id="memoryText">30%</span></small>
                </div>

                <!-- å¿«é€Ÿæ“ä½œ -->
                <div class="card p-3 mb-3">
                    <h6 class="card-title fw-bold"><i class="fas fa-bolt me-2"></i>å¿«é€Ÿæ“ä½œ</h6>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-sm" id="quickLoginBtn">
                            <i class="fas fa-sign-in-alt me-1"></i> å¿«é€Ÿç™»å½•è´¦å·
                        </button>
                        <button class="btn btn-outline-success btn-sm" id="refreshAllBtn">
                            <i class="fas fa-sync-alt me-1"></i> åˆ·æ–°æ‰€æœ‰Cookie
                        </button>
                        <button class="btn btn-outline-warning btn-sm" id="cleanCacheBtn">
                            <i class="fas fa-trash-alt me-1"></i> æ¸…ç†ç¼“å­˜
                        </button>
                        <button class="btn btn-outline-info btn-sm" id="exportConfigBtn">
                            <i class="fas fa-download me-1"></i> å¯¼å‡ºé…ç½®
                        </button>
                    </div>
                </div>


                <!-- API Key ç®¡ç† -->
                <div class="card p-3 mb-3">
                    <h6 class="card-title fw-bold"><i class="fas fa-key me-2"></i>API Key ç®¡ç†</h6>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">å½“å‰ API Key:</small>
                            <code class="small bg-light p-1 rounded" id="currentApiKey">åŠ è½½ä¸­...</code>
                        </div>
                        <div class="input-group input-group-sm">
                            <input type="password" class="form-control" id="newApiKey" placeholder="è¾“å…¥æ–° API Key">
                            <button class="btn btn-primary" type="button" id="updateApiKeyBtn">
                                <i class="fas fa-save"></i>
                            </button>
                        </div>
                        <small class="text-muted d-block mt-2">
                            ç”¨äºéªŒè¯å®¢æˆ·ç«¯è¯·æ±‚ã€‚é»˜è®¤: 1
                        </small>
                    </div>
                </div>

            </div>

            <!-- ä¸­é—´ä¸»å†…å®¹ -->
            <div class="col-lg-6">
                <!-- æ¬¢è¿å¡ç‰‡ -->
                <div class="card p-4 mb-4 text-center border-primary">
                    <div class="card-body">
                        <h4 class="card-title text-primary mb-3">
                            <i class="fas fa-rocket me-2"></i>æ¬¢è¿ä½¿ç”¨ Perplexity-2API æ§åˆ¶å°ï¼
                        </h4>
                        <p class="card-text mb-3">
                            æµè§ˆå™¨ç™»å½•æ–¹å¼æš‚æ—¶ä¸å¯ç”¨ï¼Œå› ä¸ºå‰ç«¯çš„äººæœºéªŒè¯å¤ªå±Œäº†ï¼Œç»•ä¸è¿‡ï¼Œå°±ç®—å¤„ç†äº†ä»–çš„éªŒè¯å¯æ˜¯ä»–åå¤è·³è½¬éªŒè¯ã€‚
                        </p>
                        <div class="alert alert-info mb-4">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>è¯·é€‰æ‹©ä»¥ä¸‹æ–¹å¼æ·»åŠ è´¦å·ï¼š</strong>
                        </div>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <div class="card h-100 border-success">
                                    <div class="card-body">
                                        <h5 class="card-title text-success">
                                            <i class="fas fa-sign-in-alt me-2"></i>æ–¹å¼ä¸€ï¼šå¿«é€Ÿç™»å½•
                                        </h5>
                                        <p class="card-text small">
                                            ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œå°†è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨è®©æ‚¨ç™»å½• Perplexity è´¦æˆ·ã€‚
                                        </p>
                                        <button class="btn btn-success w-100 mt-2" id="mainQuickLoginBtn">
                                            <i class="fas fa-external-link-alt me-1"></i> æ‰“å¼€æµè§ˆå™¨ç™»å½•
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100 border-primary">
                                    <div class="card-body">
                                        <h5 class="card-title text-primary">
                                            <i class="fas fa-paste me-2"></i>æ–¹å¼äºŒï¼šç²˜è´´ Cookie
                                        </h5>
                                        <p class="card-text small">
                                            å¦‚æœæ‚¨å·²æœ‰ Cookie æ–‡æœ¬ï¼Œå¯ç›´æ¥ç²˜è´´åˆ°ä¸‹æ–¹è¾“å…¥æ¡†ã€‚
                                        </p>
                                        <button class="btn btn-primary w-100 mt-2" type="button" data-bs-toggle="collapse" data-bs-target="#mainCookieInput">
                                            <i class="fas fa-keyboard me-1"></i> æ˜¾ç¤º Cookie è¾“å…¥æ¡†
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä¸» Cookie è¾“å…¥æ¡† -->
                <div class="collapse show" id="mainCookieInput">
                    <div class="card p-4 mb-4">
                        <h5 class="card-title fw-bold mb-3">
                            <i class="fas fa-cookie-bite me-2"></i>Cookie è¾“å…¥ & è§£æ
                        </h5>
                        
                        <div class="alert alert-warning mb-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>æ”¯æŒå¤šç§æ ¼å¼ï¼š</strong> HAR JSONã€PowerShellã€cURLã€çº¯ Cookie å­—ç¬¦ä¸²
                        </div>
                        
                        <div class="mb-3">
                            <label for="mainCookieText" class="form-label fw-bold">
                                <i class="fas fa-paste me-1"></i>ç²˜è´´ Cookie æ–‡æœ¬
                            </label>
                            <textarea class="form-control" id="mainCookieText" rows="6" 
                                      placeholder="è¯·ç²˜è´´æ‚¨çš„ Cookie æ–‡æœ¬...&#10;ä¾‹å¦‚ï¼š&#10;pplx.visitor-id=xxx; session-token=yyy&#10;æˆ–å®Œæ•´çš„ HAR JSONã€PowerShell æ ¼å¼"></textarea>
                            <div class="form-text">
                                Tip: å¯ä»¥ä»æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰çš„ Network æ ‡ç­¾ä¸­å¤åˆ¶ Cookie
                            </div>
                        </div>
                        
                        <div class="row g-3 mb-3">
                            <div class="col-md-8">
                                <label for="mainAccountName" class="form-label fw-bold">
                                    <i class="fas fa-user me-1"></i>è´¦å·åç§°
                                </label>
                                <input type="text" class="form-control" id="mainAccountName" 
                                       placeholder="ä¸ºè¿™ä¸ªè´¦å·èµ·ä¸ªåå­—ï¼ˆå¯é€‰ï¼‰" value="æˆ‘çš„è´¦å·">
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button class="btn btn-primary w-100" id="mainParseCookieBtn">
                                    <i class="fas fa-magic me-1"></i> è§£æå¹¶æ·»åŠ 
                                </button>
                            </div>
                        </div>
                        
                        <div class="text-center mt-3">
                            <div class="spinner-border spinner-border-sm text-primary d-none" id="mainParseSpinner"></div>
                            <div class="text-muted small" id="mainParseResult"></div>
                        </div>
                        
                        <div class="mt-4 pt-3 border-top">
                            <h6 class="fw-bold mb-2">
                                <i class="fas fa-question-circle me-2"></i>å¦‚ä½•è·å– Cookieï¼Ÿ
                            </h6>
                            <ol class="small ps-3 mb-0">
                                <li class="mb-1">æ‰“å¼€ <a href="https://www.perplexity.ai" target="_blank">Perplexity.ai</a> å¹¶ç™»å½•æ‚¨çš„è´¦æˆ·</li>
                                <li class="mb-1">æŒ‰ <code>F12</code> æ‰“å¼€å¼€å‘è€…å·¥å…·</li>
                                <li class="mb-1">åˆ‡æ¢åˆ° <strong>Network</strong> (ç½‘ç»œ) æ ‡ç­¾</li>
                                <li class="mb-1">åˆ·æ–°é¡µé¢ï¼Œç‚¹å‡»ä»»æ„è¯·æ±‚ï¼ˆé€šå¸¸æ˜¯ <code>search</code> æˆ– <code>api</code>ï¼‰</li>
                                <li class="mb-1">åœ¨ <strong>Headers</strong> ä¸­æ‰¾åˆ° <code>Cookie</code> å­—æ®µ</li>
                                <li>å¤åˆ¶æ•´ä¸ª Cookie å­—ç¬¦ä¸²ç²˜è´´åˆ°ä¸Šæ–¹è¾“å…¥æ¡†</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- è´¦å·çŠ¶æ€å¡ç‰‡ï¼ˆæœ‰è´¦å·æ—¶æ˜¾ç¤ºï¼‰ -->
                <div class="card p-4 d-none" id="accountStatusCard">
                    <h5 class="card-title fw-bold mb-3">
                        <i class="fas fa-chart-line me-2"></i>è´¦å·çŠ¶æ€æ¦‚è§ˆ
                    </h5>
                    <div id="accountStatusContent">
                        <!-- é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ä¾§è¾¹æ  -->
            <div class="col-lg-3">
                <!-- è´¦å·ç®¡ç† -->
                <div class="card p-3 mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="card-title fw-bold mb-0">
                            <i class="fas fa-users me-2"></i>è´¦å·ç®¡ç†
                            <span class="badge bg-secondary ms-2" id="accountsCount">0</span>
                        </h6>
                        <button class="btn btn-sm btn-success" id="addAccountBtn">
                            <i class="fas fa-plus"></i> æ·»åŠ 
                        </button>
                    </div>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>çŠ¶æ€</th>
                                    <th>è´¦å·</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="accountsTable">
                                <tr>
                                    <td colspan="3" class="text-center text-muted py-3">
                                        åŠ è½½è´¦å·åˆ—è¡¨...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-2">
                        <div class="d-flex justify-content-between small">
                            <span class="text-muted">æ´»è·ƒ:</span>
                            <span class="badge bg-success" id="activeAccounts">0</span>
                        </div>
                        <div class="d-flex justify-content-between small">
                            <span class="text-muted">å¤±æ•ˆ:</span>
                            <span class="badge bg-danger" id="inactiveAccounts">0</span>
                        </div>
                    </div>
                    
                    <!-- Cookie å¯¼å…¥åŠŸèƒ½ -->
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-info w-100 mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#cookieImportCollapse">
                            <i class="fas fa-paste me-1"></i> å¯¼å…¥ Cookie æ–‡æœ¬
                        </button>
                        <div class="collapse" id="cookieImportCollapse">
                            <div class="border rounded p-2 bg-light">
                                <small class="text-muted d-block mb-2">
                                    æ”¯æŒæ ¼å¼ï¼šHAR JSONã€PowerShellã€cURLã€çº¯ Cookie å­—ç¬¦ä¸²
                                </small>
                                <textarea class="form-control form-control-sm mb-2" id="cookieText" rows="3" placeholder="ç²˜è´´ Cookie æ–‡æœ¬..."></textarea>
                                <div class="input-group input-group-sm mb-2">
                                    <input type="text" class="form-control" id="importAccountName" placeholder="è´¦å·åç§°ï¼ˆå¯é€‰ï¼‰" value="å¯¼å…¥çš„è´¦å·">
                                    <button class="btn btn-primary" type="button" id="parseCookieBtn">
                                        <i class="fas fa-magic me-1"></i> è§£æ
                                    </button>
                                </div>
                                <div class="text-center small">
                                    <span class="text-muted" id="parseResult"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ¨¡å‹ç®¡ç† -->
                <div class="card p-3 mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="card-title fw-bold mb-0">
                            <i class="fas fa-robot me-2"></i>æ¨¡å‹ç®¡ç†
                            <span class="badge bg-secondary ms-2" id="modelsCount">0</span>
                        </h6>
                        <button class="btn btn-sm btn-success" id="addModelBtn">
                            <i class="fas fa-plus"></i> æ·»åŠ 
                        </button>
                    </div>
                    <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>æ¨¡å‹</th>
                                    <th>æä¾›å•†</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="modelsTable">
                                <tr>
                                    <td colspan="3" class="text-center text-muted py-2">
                                        åŠ è½½ä¸­...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-2 small">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">è‡ªå®šä¹‰:</span>
                            <span class="badge bg-info" id="customModelsCount">0</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">é¢„è®¾:</span>
                            <span class="badge bg-secondary" id="presetModelsCount">0</span>
                        </div>
                    </div>
                </div>

                <!-- ä¼šè¯ç®¡ç† -->
                <div class="card p-3 mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="card-title fw-bold mb-0">
                            <i class="fas fa-comments me-2"></i>ä¼šè¯ç®¡ç†
                        </h6>
                        <button class="btn btn-sm btn-outline-danger" id="resetAllConversationsBtn" title="é‡ç½®æ‰€æœ‰ä¼šè¯">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between small">
                            <span class="text-muted">æ´»è·ƒä¼šè¯:</span>
                            <span class="badge bg-info" id="activeConversations">0</span>
                        </div>
                        <div class="d-flex justify-content-between small">
                            <span class="text-muted">æœ€å¤§è½®æ¬¡:</span>
                            <span id="maxTurnsPerConv">50</span>
                        </div>
                        <div class="d-flex justify-content-between small">
                            <span class="text-muted">æœ€å¤§ä¼šè¯æ•°:</span>
                            <span id="maxConversations">10</span>
                        </div>
                    </div>
                    <div class="mt-2" id="conversationsList" style="max-height: 150px; overflow-y: auto;">
                        <div class="text-center text-muted small py-2">
                            æš‚æ— æ´»è·ƒä¼šè¯
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted d-block">
                            <i class="fas fa-info-circle me-1"></i>
                            æ¯ä¸ªä¼šè¯æœ€å¤š50è½®å¯¹è¯ï¼Œè¶…è¿‡åè‡ªåŠ¨åˆ›å»ºæ–°ä¼šè¯
                        </small>
                    </div>
                </div>

                <!-- API ç«¯ç‚¹ -->
                <div class="card p-3 mb-3">
                    <h6 class="card-title fw-bold"><i class="fas fa-code me-2"></i>API ç«¯ç‚¹</h6>
                    <div class="mb-2">
                        <div class="api-box mb-1">
                            <small class="text-info">POST</small> /v1/chat/completions
                        </div>
                        <div class="api-box mb-1">
                            <small class="text-info">GET</small> /v1/models
                        </div>
                        <div class="api-box mb-1">
                            <small class="text-info">GET</small> /api/system/status
                        </div>
                        <div class="api-box mb-1">
                            <small class="text-info">GET</small> /api/conversations
                        </div>
                        <div class="api-box">
                            <small class="text-info">POST</small> /api/conversations/reset
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">API Key:</small>
                        <code class="small d-block bg-light p-1 rounded">1 (æˆ– .env ä¸­é…ç½®)</code>
                    </div>
                </div>

                <!-- ç³»ç»Ÿä¿¡æ¯ -->
                <div class="card p-3">
                    <h6 class="card-title fw-bold"><i class="fas fa-info-circle me-2"></i>ç³»ç»Ÿä¿¡æ¯</h6>
                    <div class="small">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">ç‰ˆæœ¬:</span>
                            <span>v3.0</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">å¯åŠ¨æ—¶é—´:</span>
                            <span id="uptime">--</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Python:</span>
                            <span id="pythonVersion">--</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">ä¸»æœº:</span>
                            <span id="hostName">--</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">å·¥ä½œç›®å½•:</span>
                            <span class="text-truncate" style="max-width: 150px;" id="workingDir">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨çŠ¶æ€æ  -->
        <footer class="mt-4 pt-3 border-top">
            <div class="row">
                <div class="col-md-8">
                    <small class="text-muted">
                        <i class="fas fa-exclamation-circle me-1"></i>
                        æç¤º: ç‚¹å‡»"å¿«é€Ÿç™»å½•è´¦å·"å°†åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ https://www.perplexity.ai/ï¼Œç™»å½•åCookieä¼šè‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°
                    </small>
                </div>
                <div class="col-md-4 text-end">
                    <small class="text-muted" id="lastUpdate">
                        æœ€åæ›´æ–°: <span id="updateTime">--</span>
                    </small>
                </div>
            </div>
        </footer>
    </div>

    <!-- JavaScript -->
    <script>
        // å…¨å±€çŠ¶æ€
        let systemState = {
            logs: [],
            files: [],
            accounts: [],
            selectedFiles: new Set(),
            isLogPaused: false,
            autoScroll: true,
            logFilters: {
                info: true,
                warning: true,
                error: true,
                debug: false
            }
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
            loadAllData();
            startLiveUpdates();
        });

        // ç³»ç»Ÿåˆå§‹åŒ–
        function initializeSystem() {
            // æ›´æ–°ç³»ç»Ÿä¿¡æ¯
            fetch('/api/system/info')
                .then(res => res.json())
                .then(data => {
                    if (data.python_version) {
                        document.getElementById('pythonVersion').textContent = data.python_version;
                    }
                    if (data.host_name) {
                        document.getElementById('hostName').textContent = data.host_name;
                    }
                    if (data.working_dir) {
                        document.getElementById('workingDir').textContent = data.working_dir;
                    }
                    if (data.uptime) {
                        document.getElementById('uptime').textContent = data.uptime;
                    }
                })
                .catch(console.error);

            // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
            updateTime();
            setInterval(updateTime, 60000); // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
        }

        // æ›´æ–°å½“å‰æ—¶é—´
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN');
            document.getElementById('updateTime').textContent = timeStr;
        }

        // åŠ è½½æ‰€æœ‰æ•°æ®
        function loadAllData() {
            loadSystemStatus();
            loadAccounts();
            loadLogs();
            loadApiKey();
            loadModels();
            loadConversations();
        }

        // åŠ è½½ç³»ç»ŸçŠ¶æ€
        function loadSystemStatus() {
            fetch('/api/system/status')
                .then(res => res.json())
                .then(data => {
                    // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
                    if (data.service_status === 'running') {
                        document.getElementById('serviceStatus').className = 'badge bg-success';
                        document.getElementById('serviceStatus').textContent = 'è¿è¡Œä¸­';
                        document.getElementById('systemStatus').innerHTML = 'ğŸŸ¢ ç³»ç»Ÿè¿è¡Œæ­£å¸¸';
                    } else {
                        document.getElementById('serviceStatus').className = 'badge bg-danger';
                        document.getElementById('serviceStatus').textContent = 'åœæ­¢';
                        document.getElementById('systemStatus').innerHTML = 'ğŸ”´ ç³»ç»Ÿå¼‚å¸¸';
                    }

                    // æ›´æ–°BotasaurusçŠ¶æ€
                    if (data.botasaurus_status === 'initialized') {
                        document.getElementById('botasaurusStatus').className = 'badge bg-success';
                        document.getElementById('botasaurusStatus').textContent = 'å·²å°±ç»ª';
                    } else if (data.botasaurus_status === 'initializing') {
                        document.getElementById('botasaurusStatus').className = 'badge bg-warning';
                        document.getElementById('botasaurusStatus').textContent = 'åˆå§‹åŒ–ä¸­';
                    } else {
                        document.getElementById('botasaurusStatus').className = 'badge bg-danger';
                        document.getElementById('botasaurusStatus').textContent = 'å¤±è´¥';
                    }

                    // æ›´æ–°è´¦å·æ± çŠ¶æ€
                    document.getElementById('accountPoolStatus').textContent = 
                        `${data.active_accounts || 0}/${data.total_accounts || 0}`;
                    
                    // æ›´æ–°APIè¯·æ±‚è®¡æ•°
                    document.getElementById('apiRequestCount').textContent = data.api_requests || 0;

                    // æ›´æ–°å†…å­˜ä½¿ç”¨
                    if (data.memory_usage) {
                        const memoryPercent = Math.min(100, Math.max(0, data.memory_usage));
                        document.getElementById('memoryUsage').style.width = `${memoryPercent}%`;
                        document.getElementById('memoryText').textContent = `${memoryPercent}%`;
                    }
                })
                .catch(console.error);
        }

        // åŠ è½½è´¦å·åˆ—è¡¨
        function loadAccounts() {
            fetch('/api/accounts')
                .then(res => res.json())
                .then(data => {
                    systemState.accounts = data.accounts || [];
                    updateAccountsTable();
                    
                    // æ›´æ–°è®¡æ•°
                    document.getElementById('accountsCount').textContent = systemState.accounts.length;
                    const active = systemState.accounts.filter(a => a.is_active).length;
                    const inactive = systemState.accounts.length - active;
                    document.getElementById('activeAccounts').textContent = active;
                    document.getElementById('inactiveAccounts').textContent = inactive;
                    
                    // æ›´æ–°UIçŠ¶æ€ï¼ˆæ˜¾ç¤º/éšè—æ¬¢è¿å¡ç‰‡ï¼‰
                    updateUIState();
                })
                .catch(console.error);
        }

        // æ›´æ–°è´¦å·è¡¨æ ¼
        function updateAccountsTable() {
            const tbody = document.getElementById('accountsTable');
            if (systemState.accounts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted py-3">
                            æš‚æ— è´¦å·ï¼Œç‚¹å‡»"æ·»åŠ "æŒ‰é’®åˆ›å»º
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            systemState.accounts.slice(0, 5).forEach(account => {
                const statusClass = account.is_active ? 
                    (account.token && account.token.length > 20 ? 'success' : 'warning') : 'secondary';
                const statusIcon = account.is_active ? 
                    (account.token && account.token.length > 20 ? 'âœ…' : 'âš ï¸') : 'â¸ï¸';
                
                html += `
                    <tr>
                        <td>
                            <span class="badge bg-${statusClass}">${statusIcon}</span>
                        </td>
                        <td>
                            <div class="small">${account.name || 'æœªå‘½å'}</div>
                            <div class="text-muted" style="font-size: 10px;">${account.data_dir || ''}</div>
                            <div class="text-muted" style="font-size: 9px;">Cookie: ${account.cookie_count || 0}ä¸ª</div>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshAccount('${account.id}')" title="åˆ·æ–°">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success mt-1" onclick="verifyAccount('${account.name}')" title="éªŒè¯Cookie">
                                <i class="fas fa-check-circle"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            if (systemState.accounts.length > 5) {
                html += `
                    <tr>
                        <td colspan="4" class="text-center">
                            <small class="text-muted">
                                è¿˜æœ‰ ${systemState.accounts.length - 5} ä¸ªè´¦å·...
                            </small>
                        </td>
                    </tr>
                `;
            }

            tbody.innerHTML = html;
        }



        // æ›´æ–°UIçŠ¶æ€ï¼ˆæ˜¾ç¤º/éšè—æ¬¢è¿å¡ç‰‡ï¼‰
        function updateUIState() {
            const hasAccounts = systemState.accounts.length > 0;
            const welcomeCard = document.querySelector('#mainCookieInput');
            const statusCard = document.getElementById('accountStatusCard');
            
            if (hasAccounts) {
                // æœ‰è´¦å·ï¼šéšè—æ¬¢è¿å¡ç‰‡ï¼Œæ˜¾ç¤ºè´¦å·çŠ¶æ€æ¦‚è§ˆ
                welcomeCard?.classList.add('d-none');
                if (statusCard) {
                    statusCard.classList.remove('d-none');
                    // å¡«å……è´¦å·çŠ¶æ€å†…å®¹
                    const activeCount = systemState.accounts.filter(a => a.is_active).length;
                    const inactiveCount = systemState.accounts.length - activeCount;
                    const totalCalls = systemState.accounts.reduce((sum, acc) => sum + (acc.total_calls || 0), 0);
                    
                    document.getElementById('accountStatusContent').innerHTML = `
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h3 class="card-title">${systemState.accounts.length}</h3>
                                        <p class="card-text small">æ€»è´¦å·æ•°</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h3 class="card-title">${activeCount}</h3>
                                        <p class="card-text small">æ´»è·ƒè´¦å·</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h3 class="card-title">${totalCalls}</h3>
                                        <p class="card-text small">æ€»è°ƒç”¨æ¬¡æ•°</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } else {
                // æ— è´¦å·ï¼šæ˜¾ç¤ºæ¬¢è¿å¡ç‰‡å’ŒCookieè¾“å…¥æ¡†ï¼Œéšè—çŠ¶æ€å¡ç‰‡
                welcomeCard?.classList.remove('d-none');
                statusCard?.classList.add('d-none');
            }
        }

        // æ›´æ–°æ–‡ä»¶æ ‘


        // åŠ è½½æ—¥å¿—
        function loadLogs() {
            fetch('/api/logs/recent')
                .then(res => res.json())
                .then(data => {
                    systemState.logs = data.logs || [];
                    updateLiveLogs();
                    document.getElementById('logCount').textContent = systemState.logs.length;
                })
                .catch(console.error);
        }

        // åŠ è½½ API Key
        function loadApiKey() {
            fetch('/api/settings/api-key')
                .then(res => res.json())
                .then(data => {
                    const masked = data.masked || '***';
                    document.getElementById('currentApiKey').textContent = masked;
                })
                .catch(console.error);
        }

        // åŠ è½½æ¨¡å‹åˆ—è¡¨
        function loadModels() {
            fetch('/api/models')
                .then(res => res.json())
                .then(data => {
                    const models = data.models || [];
                    const customModels = models.filter(m => m.is_custom);
                    const presetModels = models.filter(m => !m.is_custom);
                    
                    document.getElementById('modelsCount').textContent = models.length;
                    document.getElementById('customModelsCount').textContent = customModels.length;
                    document.getElementById('presetModelsCount').textContent = presetModels.length;
                    
                    // æ›´æ–°è¡¨æ ¼
                    const tbody = document.getElementById('modelsTable');
                    if (models.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="3" class="text-center text-muted py-2">
                                    æš‚æ— æ¨¡å‹
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    let html = '';
                    models.slice(0, 10).forEach(model => {
                        const isCustom = model.is_custom || false;
                        const canDelete = model.can_delete !== false && isCustom;
                        const canRename = model.can_rename !== false && isCustom;
                        const modelName = model.name || model.id;
                        const modelId = model.id;
                        const provider = model.provider || 'æœªçŸ¥';
                        
                        html += `
                            <tr>
                                <td>
                                    <div class="small fw-bold">${modelName}</div>
                                    <div class="text-muted" style="font-size: 10px;">
                                        <code>${modelId}</code>
                                        <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyModelId('${modelId}')" title="å¤åˆ¶æ¨¡å‹ID">
                                            <i class="fas fa-copy" style="font-size: 10px;"></i>
                                        </button>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-${isCustom ? 'info' : 'secondary'}">
                                        ${provider}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="copyModelName('${modelName}')" title="å¤åˆ¶æ¨¡å‹åç§°">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    ${canRename ? `
                                    <button class="btn btn-sm btn-outline-primary" onclick="renameModel('${modelId}')" title="é‡å‘½å">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    ` : ''}
                                    ${canDelete ? `
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteModel('${modelId}')" title="åˆ é™¤">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    ` : ''}
                                </td>
                            </tr>
                        `;
                    });
                    
                    if (models.length > 10) {
                        html += `
                            <tr>
                                <td colspan="3" class="text-center">
                                    <small class="text-muted">
                                        è¿˜æœ‰ ${models.length - 10} ä¸ªæ¨¡å‹...
                                    </small>
                                </td>
                            </tr>
                        `;
                    }
                    
                    tbody.innerHTML = html;
                })
                .catch(console.error);
        }

        // åŠ è½½ä¼šè¯åˆ—è¡¨
        function loadConversations() {
            fetch('/api/conversations')
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.stats) {
                        const stats = data.stats;
                        
                        // æ›´æ–°ç»Ÿè®¡æ•°å­—
                        document.getElementById('activeConversations').textContent = stats.active_conversations || 0;
                        document.getElementById('maxTurnsPerConv').textContent = stats.max_turns_per_conversation || 50;
                        document.getElementById('maxConversations').textContent = stats.max_conversations || 10;
                        
                        // æ›´æ–°ä¼šè¯åˆ—è¡¨
                        const listContainer = document.getElementById('conversationsList');
                        const conversations = stats.conversations || {};
                        const convIds = Object.keys(conversations);
                        
                        if (convIds.length === 0) {
                            listContainer.innerHTML = `
                                <div class="text-center text-muted small py-2">
                                    æš‚æ— æ´»è·ƒä¼šè¯
                                </div>
                            `;
                        } else {
                            let html = '';
                            convIds.forEach(cid => {
                                const conv = conversations[cid];
                                const turnCount = conv.turn_count || 0;
                                const maxTurns = stats.max_turns_per_conversation || 50;
                                const progress = Math.min(100, (turnCount / maxTurns) * 100);
                                const progressColor = progress > 80 ? 'danger' : progress > 50 ? 'warning' : 'success';
                                
                                html += `
                                    <div class="border rounded p-2 mb-2 bg-light">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="fw-bold text-truncate" style="max-width: 100px;" title="${cid}">${cid}</small>
                                            <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="resetConversation('${cid}')" title="é‡ç½®æ­¤ä¼šè¯">
                                                <i class="fas fa-times" style="font-size: 10px;"></i>
                                            </button>
                                        </div>
                                        <div class="progress mt-1" style="height: 4px;">
                                            <div class="progress-bar bg-${progressColor}" style="width: ${progress}%"></div>
                                        </div>
                                        <div class="d-flex justify-content-between mt-1">
                                            <small class="text-muted" style="font-size: 10px;">è½®æ¬¡: ${turnCount}/${maxTurns}</small>
                                            <small class="text-muted" style="font-size: 10px;">${conv.has_backend_uuid ? 'âœ…' : 'ğŸ†•'}</small>
                                        </div>
                                    </div>
                                `;
                            });
                            listContainer.innerHTML = html;
                        }
                    }
                })
                .catch(err => {
                    console.error('åŠ è½½ä¼šè¯å¤±è´¥:', err);
                });
        }

        // é‡ç½®å•ä¸ªä¼šè¯
        function resetConversation(conversationId) {
            if (!confirm(`ç¡®å®šè¦é‡ç½®ä¼šè¯ "${conversationId}" å—ï¼Ÿ\n\nè¿™å°†æ¸…é™¤è¯¥ä¼šè¯çš„ä¸Šä¸‹æ–‡è®°å¿†ã€‚`)) {
                return;
            }
            
            fetch('/api/conversations/reset', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ conversation_id: conversationId })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast(`âœ… ä¼šè¯ "${conversationId}" å·²é‡ç½®`, 'success');
                    loadConversations();
                } else {
                    alert(`âŒ é‡ç½®å¤±è´¥: ${data.message}`);
                }
            })
            .catch(err => {
                alert(`âŒ è¯·æ±‚å¤±è´¥: ${err.message}`);
            });
        }

        // é‡ç½®æ‰€æœ‰ä¼šè¯
        function resetAllConversations() {
            if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰ä¼šè¯å—ï¼Ÿ\n\nè¿™å°†æ¸…é™¤æ‰€æœ‰ä¼šè¯çš„ä¸Šä¸‹æ–‡è®°å¿†ã€‚')) {
                return;
            }
            
            fetch('/api/conversations/reset-all', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    loadConversations();
                } else {
                    alert(`âŒ é‡ç½®å¤±è´¥: ${data.message}`);
                }
            })
            .catch(err => {
                alert(`âŒ è¯·æ±‚å¤±è´¥: ${err.message}`);
            });
        }

        // å¯¼å‡ºä¸ºå…¨å±€å‡½æ•°
        window.resetConversation = resetConversation;
        window.resetAllConversations = resetAllConversations;

        // æ›´æ–°å®æ—¶æ—¥å¿—
        function updateLiveLogs() {
            if (systemState.isLogPaused) return;
            
            const container = document.getElementById('liveLogs');
            let html = '';
            
            systemState.logs.slice(-50).forEach(log => {
                const level = log.level || 'info';
                if (!systemState.logFilters[level]) return;
                
                const time = log.timestamp ? log.timestamp.split(' ')[1] : '--:--:--';
                const message = log.message || '';
                
                html += `
                    <div class="log-line ${level}">
                        <span class="text-muted">[${time}]</span> ${message}
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            if (systemState.autoScroll) {
                container.scrollTop = container.scrollHeight;
            }
        }

        // æ›´æ–°å­˜å‚¨ä¿¡æ¯


        // å¼€å§‹å®æ—¶æ›´æ–°
        function startLiveUpdates() {
            // é¡µé¢å¯è§æ€§æ£€æµ‹ï¼šå½“é¡µé¢éšè—æ—¶æš‚åœè½®è¯¢
            let isPageVisible = true;
            document.addEventListener('visibilitychange', function() {
                isPageVisible = !document.hidden;
            });
            
            // ç³»ç»ŸçŠ¶æ€æ¯30ç§’æ›´æ–°ä¸€æ¬¡ï¼ˆé¡µé¢å¯è§æ—¶ï¼‰
            setInterval(() => {
                if (isPageVisible) loadSystemStatus();
            }, 30000);
            
            // è´¦å·æ¯120ç§’æ›´æ–°ä¸€æ¬¡ï¼ˆé¡µé¢å¯è§æ—¶ï¼‰
            setInterval(() => {
                if (isPageVisible) loadAccounts();
            }, 120000);
            
            // æ—¥å¿—æ¯30ç§’æ›´æ–°ä¸€æ¬¡ï¼ˆé¡µé¢å¯è§æ—¶ï¼‰
            setInterval(() => {
                if (isPageVisible) loadLogs();
            }, 30000);
            
            // ä¼šè¯æ¯15ç§’æ›´æ–°ä¸€æ¬¡ï¼ˆé¡µé¢å¯è§æ—¶ï¼‰
            setInterval(() => {
                if (isPageVisible) loadConversations();
            }, 15000);
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // äº‹ä»¶ç›‘å¬å™¨è®¾ç½®ï¼ˆå¢å¼ºç‰ˆï¼šå®‰å…¨æ£€æŸ¥ï¼‰
        function setupEventListeners() {
            // å®‰å…¨æ£€æŸ¥è¾…åŠ©å‡½æ•°
            function safeAddEventListener(id, event, handler) {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener(event, handler);
                } else {
                    console.warn(`âš ï¸ å…ƒç´  #${id} ä¸å­˜åœ¨ï¼Œè·³è¿‡äº‹ä»¶ç»‘å®š`);
                }
            }
            
            // å®‰å…¨æŸ¥è¯¢é€‰æ‹©å™¨
            function safeQuerySelectorAll(selector, handler) {
                const elements = document.querySelectorAll(selector);
                if (elements.length > 0) {
                    elements.forEach(el => {
                        el.addEventListener('change', handler);
                    });
                } else {
                    console.warn(`âš ï¸ é€‰æ‹©å™¨ ${selector} æœªæ‰¾åˆ°å…ƒç´ ï¼Œè·³è¿‡äº‹ä»¶ç»‘å®š`);
                }
            }

            // è‡ªåŠ¨æ»šåŠ¨ï¼ˆå¦‚æœå…ƒç´ å­˜åœ¨ï¼‰
            safeAddEventListener('autoScroll', 'change', function(e) {
                systemState.autoScroll = e.target.checked;
            });

            // æ—¥å¿—çº§åˆ«è¿‡æ»¤ï¼ˆå¦‚æœå…ƒç´ å­˜åœ¨ï¼‰
            safeQuerySelectorAll('.log-level', function(e) {
                const level = e.target.id.replace('show', '').toLowerCase();
                systemState.logFilters[level] = e.target.checked;
                updateLiveLogs();
            });

            // æš‚åœæ—¥å¿—ï¼ˆå¦‚æœå…ƒç´ å­˜åœ¨ï¼‰
            safeAddEventListener('pauseLogsBtn', 'click', function() {
                systemState.isLogPaused = !systemState.isLogPaused;
                const icon = this.querySelector('i');
                if (systemState.isLogPaused) {
                    icon.className = 'fas fa-play';
                    this.title = 'ç»§ç»­æ—¥å¿—';
                } else {
                    icon.className = 'fas fa-pause';
                    this.title = 'æš‚åœæ—¥å¿—';
                    updateLiveLogs();
                }
            });

            // æ¸…ç©ºæ—¥å¿—ï¼ˆå¦‚æœå…ƒç´ å­˜åœ¨ï¼‰
            safeAddEventListener('clearLogsBtn', 'click', function() {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥å¿—å—ï¼Ÿ')) {
                    fetch('/api/logs/clear', { method: 'POST' })
                        .then(() => {
                            systemState.logs = [];
                            updateLiveLogs();
                        })
                        .catch(console.error);
                }
            });

            // å¿«é€Ÿç™»å½•
            safeAddEventListener('quickLoginBtn', 'click', function() {
                const accountName = prompt('è¯·è¾“å…¥è´¦å·åç§°ï¼ˆå¯é€‰ï¼‰:', 'æ–°è´¦å·');
                if (accountName === null) return;
                
                fetch('/api/account/login/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `name=${encodeURIComponent(accountName || 'æ–°è´¦å·')}`
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert(`âœ… ç™»å½•æµç¨‹å·²å¯åŠ¨\n\nè¯·åœ¨æ‰“å¼€çš„æµè§ˆå™¨ä¸­ç™»å½• https://www.perplexity.ai/\nç™»å½•æˆåŠŸåCookieå°†è‡ªåŠ¨ä¿å­˜ã€‚`);
                        loadAccounts();
                    } else {
                        alert(`âŒ å¯åŠ¨å¤±è´¥: ${data.message}`);
                    }
                })
                .catch(err => {
                    alert(`âŒ é”™è¯¯: ${err.message}`);
                });
            });

            // åˆ·æ–°æ‰€æœ‰Cookie
            safeAddEventListener('refreshAllBtn', 'click', function() {
                if (confirm('ç¡®å®šè¦åˆ·æ–°æ‰€æœ‰è´¦å·çš„Cookieå—ï¼Ÿ')) {
                    fetch('/api/accounts/refresh-all', { method: 'POST' })
                        .then(res => res.json())
                        .then(data => {
                            alert(data.message || 'åˆ·æ–°è¯·æ±‚å·²å‘é€');
                            loadAccounts();
                        })
                        .catch(console.error);
                }
            });

            // é‡ç½®æ‰€æœ‰ä¼šè¯æŒ‰é’®
            safeAddEventListener('resetAllConversationsBtn', 'click', function() {
                resetAllConversations();
            });

            // æ¸…ç†ç¼“å­˜
            safeAddEventListener('cleanCacheBtn', 'click', function() {
                if (confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰ç¼“å­˜æ–‡ä»¶å—ï¼Ÿ\n\nè¿™å°†åˆ é™¤ä¸´æ—¶æ–‡ä»¶ï¼Œä½†ä¿ç•™è´¦å·æ•°æ®ã€‚')) {
                    fetch('/api/files/clean-cache', { method: 'POST' })
                        .then(res => res.json())
                        .then(data => {
                            alert(data.message || 'ç¼“å­˜æ¸…ç†å®Œæˆ');
                        })
                        .catch(console.error);
                }
            });

            // å¯¼å‡ºé…ç½®ï¼ˆæ–°å¢ï¼‰
            safeAddEventListener('exportConfigBtn', 'click', function() {
                fetch('/api/settings/export-config', { method: 'GET' })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            // åˆ›å»ºä¸‹è½½é“¾æ¥
                            const blob = new Blob([JSON.stringify(data.config, null, 2)], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `perplexity-config-${new Date().toISOString().slice(0,10)}.json`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                            
                            showToast('âœ… é…ç½®å¯¼å‡ºæˆåŠŸï¼', 'success');
                        } else {
                            alert(`âŒ å¯¼å‡ºå¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`);
                        }
                    })
                    .catch(err => {
                        console.error('å¯¼å‡ºé…ç½®å¤±è´¥:', err);
                        // ä¸´æ—¶å®ç°ï¼šæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯ï¼ˆæ¨¡æ‹Ÿï¼‰
                        showToast('âœ… é…ç½®å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­ï¼Œå½“å‰ç‰ˆæœ¬å·²ä¿å­˜æ‰€æœ‰é…ç½®åˆ°æœ¬åœ°ç›®å½•', 'info');
                    });
            });

            // æ·»åŠ è´¦å·æŒ‰é’®
            safeAddEventListener('addAccountBtn', 'click', function() {
                document.getElementById('quickLoginBtn')?.click();
            });

            // Cookie è§£ææŒ‰é’®
            safeAddEventListener('parseCookieBtn', 'click', function() {
                const cookieText = document.getElementById('cookieText')?.value.trim();
                const accountName = document.getElementById('importAccountName')?.value.trim() || 'å¯¼å…¥çš„è´¦å·';
                
                if (!cookieText) {
                    alert('è¯·å…ˆç²˜è´´ Cookie æ–‡æœ¬');
                    return;
                }
                
                const resultElem = document.getElementById('parseResult');
                if (resultElem) {
                    resultElem.textContent = 'æ­£åœ¨è§£æ...';
                    resultElem.className = 'text-muted';
                }
                
                fetch('/api/cookie/parse', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: cookieText,
                        account_name: accountName
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (resultElem) {
                        if (data.success) {
                            resultElem.textContent = `âœ… ${data.message}`;
                            resultElem.className = 'text-success';
                            
                            // æ¸…ç©ºæ–‡æœ¬åŒºåŸŸ
                            const cookieTextArea = document.getElementById('cookieText');
                            if (cookieTextArea) cookieTextArea.value = '';
                            
                            // æ›´æ–°è´¦å·åˆ—è¡¨
                            loadAccounts();
                            
                            // 3ç§’åéšè—ç»“æœ
                            setTimeout(() => {
                                resultElem.textContent = '';
                            }, 3000);
                        } else {
                            resultElem.textContent = `âŒ ${data.message}`;
                            resultElem.className = 'text-danger';
                        }
                    }
                })
                .catch(err => {
                    if (resultElem) {
                        resultElem.textContent = `âŒ è¯·æ±‚å¤±è´¥: ${err.message}`;
                        resultElem.className = 'text-danger';
                    }
                });
            });

            // API Key æ›´æ–°
            safeAddEventListener('updateApiKeyBtn', 'click', function() {
                const newKey = document.getElementById('newApiKey')?.value.trim();
                if (!newKey) {
                    alert('è¯·è¾“å…¥æ–°çš„ API Key');
                    return;
                }
                
                if (!confirm('ç¡®å®šè¦æ›´æ–° API Key å—ï¼Ÿ\n\nè¯·æ³¨æ„ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½éœ€è¦é‡å¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆã€‚')) {
                    return;
                }
                
                fetch('/api/settings/api-key', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ api_key: newKey })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message || 'âœ… API Key æ›´æ–°æˆåŠŸ');
                        const newKeyInput = document.getElementById('newApiKey');
                        if (newKeyInput) newKeyInput.value = '';
                        loadApiKey();
                    } else {
                        alert('âŒ æ›´æ–°å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(err => {
                    alert('âŒ è¯·æ±‚å¤±è´¥: ' + err.message);
                });
            });

            // ä¸»åŒºåŸŸå¿«é€Ÿç™»å½•æŒ‰é’®
            safeAddEventListener('mainQuickLoginBtn', 'click', function() {
                const accountName = prompt('è¯·è¾“å…¥è´¦å·åç§°ï¼ˆå¯é€‰ï¼‰:', 'æ–°è´¦å·');
                if (accountName === null) return;
                
                fetch('/api/account/login/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `name=${encodeURIComponent(accountName || 'æ–°è´¦å·')}`
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert(`âœ… ç™»å½•æµç¨‹å·²å¯åŠ¨\n\nè¯·åœ¨æ‰“å¼€çš„æµè§ˆå™¨ä¸­ç™»å½• https://www.perplexity.ai/\nç™»å½•æˆåŠŸåCookieå°†è‡ªåŠ¨ä¿å­˜ã€‚`);
                        loadAccounts();
                    } else {
                        alert(`âŒ å¯åŠ¨å¤±è´¥: ${data.message}`);
                    }
                })
                .catch(err => {
                    alert(`âŒ é”™è¯¯: ${err.message}`);
                });
            });

            // ä¸»åŒºåŸŸCookieè§£ææŒ‰é’®
            safeAddEventListener('mainParseCookieBtn', 'click', function() {
                const cookieText = document.getElementById('mainCookieText')?.value.trim();
                const accountName = document.getElementById('mainAccountName')?.value.trim() || 'æˆ‘çš„è´¦å·';
                
                if (!cookieText) {
                    alert('è¯·å…ˆç²˜è´´ Cookie æ–‡æœ¬');
                    return;
                }
                
                const spinner = document.getElementById('mainParseSpinner');
                const resultElem = document.getElementById('mainParseResult');
                
                if (spinner) spinner.classList.remove('d-none');
                if (resultElem) {
                    resultElem.textContent = 'æ­£åœ¨è§£æ Cookie...';
                    resultElem.className = 'text-muted';
                }
                
                fetch('/api/cookie/parse', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: cookieText,
                        account_name: accountName
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (spinner) spinner.classList.add('d-none');
                    
                    if (resultElem) {
                        if (data.success) {
                            resultElem.textContent = `âœ… ${data.message}`;
                            resultElem.className = 'text-success';
                            
                            // æ¸…ç©ºæ–‡æœ¬åŒºåŸŸ
                            const mainCookieText = document.getElementById('mainCookieText');
                            if (mainCookieText) mainCookieText.value = '';
                            
                            // æ›´æ–°è´¦å·åˆ—è¡¨
                            loadAccounts();
                            
                            // 5ç§’åæ¸…é™¤ç»“æœ
                            setTimeout(() => {
                                resultElem.textContent = '';
                            }, 5000);
                        } else {
                            resultElem.textContent = `âŒ ${data.message}`;
                            resultElem.className = 'text-danger';
                        }
                    }
                })
                .catch(err => {
                    if (spinner) spinner.classList.add('d-none');
                    if (resultElem) {
                        resultElem.textContent = `âŒ è¯·æ±‚å¤±è´¥: ${err.message}`;
                        resultElem.className = 'text-danger';
                    }
                });
            });

            // æ·»åŠ æ¨¡å‹æŒ‰é’®
            safeAddEventListener('addModelBtn', 'click', function() {
                addModel();
            });

            console.log('âœ… äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–å®Œæˆ');
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        setupEventListeners();

        // è¾…åŠ©å‡½æ•°
        function showToast(message, type = 'info') {
            // åˆ›å»ºæˆ–è·å–toastå®¹å™¨
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.style.cssText = 'position:fixed;top:20px;right:20px;z-index:9999;max-width:400px;';
                document.body.appendChild(container);
            }
            
            // åˆ›å»ºtoastå…ƒç´ 
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} alert-dismissible fade show`;
            toast.style.cssText = 'margin-bottom:10px;box-shadow:0 4px 12px rgba(0,0,0,0.15);min-width:300px;';
            toast.innerHTML = `
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                ${message}
            `;
            
            container.appendChild(toast);
            
            // 5ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }
        
        function refreshAccount(accountId) {
            fetch(`/api/account/refresh/${accountId}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    alert(data.message || 'åˆ·æ–°å®Œæˆ');
                    loadAccounts();
                })
                .catch(console.error);
        }

        // å¯¼å‡ºä¸ºå…¨å±€å‡½æ•°
        window.refreshAccount = refreshAccount;
        window.verifyAccount = verifyAccount;
        window.triggerMaintenance = triggerMaintenance;
        window.viewAccountStats = viewAccountStats;
        
        // æ¨¡å‹ç®¡ç†å‡½æ•°
        function copyModelId(modelId) {
            navigator.clipboard.writeText(modelId).then(() => {
                showToast('âœ… æ¨¡å‹IDå·²å¤åˆ¶åˆ°å‰ªè´´æ¿: ' + modelId, 'success');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶: ' + modelId);
            });
        }
        
        function copyModelName(modelName) {
            navigator.clipboard.writeText(modelName).then(() => {
                showToast('âœ… æ¨¡å‹åç§°å·²å¤åˆ¶åˆ°å‰ªè´´æ¿: ' + modelName, 'success');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶: ' + modelName);
            });
        }
        
        function renameModel(modelId) {
            const newName = prompt(`è¯·è¾“å…¥æ¨¡å‹çš„æ–°åç§°:\n\nå½“å‰æ¨¡å‹ID: ${modelId}`, '');
            if (newName === null || newName.trim() === '') return;
            
            fetch(`/api/models/${encodeURIComponent(modelId)}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: newName.trim() })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    loadModels();
                } else {
                    alert(`âŒ é‡å‘½åå¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
            })
            .catch(error => {
                console.error('é‡å‘½åå¤±è´¥:', error);
                alert(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
            });
        }
        
        function deleteModel(modelId) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ¨¡å‹å—ï¼Ÿ\n\næ¨¡å‹ID: ${modelId}\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                return;
            }
            
            fetch(`/api/models/${encodeURIComponent(modelId)}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    loadModels();
                } else {
                    alert(`âŒ åˆ é™¤å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
            })
            .catch(error => {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
            });
        }
        
        // æ·»åŠ æ¨¡å‹å‡½æ•°
        function addModel() {
            const modelId = prompt('è¯·è¾“å…¥æ¨¡å‹ID (å¿…é¡»å”¯ä¸€ï¼Œå¦‚: my-model):', '');
            if (!modelId || modelId.trim() === '') return;
            
            const modelName = prompt('è¯·è¾“å…¥æ¨¡å‹æ˜¾ç¤ºåç§° (å¯é€‰):', modelId);
            if (modelName === null) return;
            
            const provider = prompt('è¯·è¾“å…¥æ¨¡å‹æä¾›å•† (å¯é€‰ï¼Œå¦‚: openai, anthropic, custom):', 'custom');
            if (provider === null) return;
            
            fetch('/api/models', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: modelId.trim(),
                    name: modelName.trim() || modelId.trim(),
                    provider: provider.trim() || 'custom'
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    loadModels();
                } else {
                    alert(`âŒ æ·»åŠ å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
            })
            .catch(error => {
                console.error('æ·»åŠ æ¨¡å‹å¤±è´¥:', error);
                alert(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
            });
        }
        
        // å¯¼å‡ºä¸ºå…¨å±€å‡½æ•°
        window.copyModelId = copyModelId;
        window.copyModelName = copyModelName;
        window.renameModel = renameModel;
        window.deleteModel = deleteModel;
        window.addModel = addModel;
        
        // éªŒè¯è´¦å·Cookie
        function verifyAccount(accountName) {
            const button = event.target.closest('button');
            const originalHtml = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            button.disabled = true;
            
            fetch(`/api/account/verify/${encodeURIComponent(accountName)}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert(`âœ… éªŒè¯æˆåŠŸï¼\n\nè´¦å·: ${accountName}\nçŠ¶æ€: ${data.message}\nCookieæ•°é‡: ${data.cookie_count || 'æœªçŸ¥'}`);
                    // é‡æ–°åŠ è½½è´¦å·åˆ—è¡¨
                    loadAccounts();
                } else {
                    alert(`âŒ éªŒè¯å¤±è´¥ï¼\n\nè´¦å·: ${accountName}\né”™è¯¯: ${data.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
            })
            .catch(error => {
                console.error('éªŒè¯å¤±è´¥:', error);
                alert(`âŒ éªŒè¯è¯·æ±‚å¤±è´¥: ${error.message}`);
            })
            .finally(() => {
                button.innerHTML = originalHtml;
                button.disabled = false;
            });
        }

        // è§¦å‘è´¦å·ç»´æŠ¤
        function triggerMaintenance(accountName) {
            if (!confirm(`ç¡®å®šè¦è§¦å‘ ${accountName} çš„è‡ªåŠ¨ç»´æŠ¤å—ï¼Ÿ\n\nè¿™å°†å¼ºåˆ¶åˆ·æ–°Cookieï¼Œå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ã€‚`)) {
                return;
            }
            
            fetch(`/api/account/maintenance/${encodeURIComponent(accountName)}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert(`âœ… ç»´æŠ¤å·²è§¦å‘ï¼\n\n${data.message}`);
                } else {
                    alert(`âŒ ç»´æŠ¤è§¦å‘å¤±è´¥: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('ç»´æŠ¤è§¦å‘å¤±è´¥:', error);
                alert(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
            });
        }

        // æŸ¥çœ‹è´¦å·ç»Ÿè®¡
        function viewAccountStats(accountName) {
            fetch(`/api/account/stats/${encodeURIComponent(accountName)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const stats = data.summary;
                        const message = `ğŸ“Š è´¦å·ç»Ÿè®¡: ${accountName}\n\n` +
                                      `æ€»è°ƒç”¨æ¬¡æ•°: ${stats.total_calls}\n` +
                                      `æˆåŠŸæ¬¡æ•°: ${stats.success_calls}\n` +
                                      `å¤±è´¥æ¬¡æ•°: ${stats.failed_calls}\n` +
                                      `æˆåŠŸç‡: ${stats.success_rate.toFixed(1)}%\n` +
                                      `è¿ç»­å¤±è´¥æ¬¡æ•°: ${stats.consecutive_failures}\n` +
                                      `æœ€åæˆåŠŸ: ${stats.last_success ? new Date(stats.last_success * 1000).toLocaleString() : 'æ— '}\n` +
                                      `æœ€åå¤±è´¥: ${stats.last_failure ? new Date(stats.last_failure * 1000).toLocaleString() : 'æ— '}`;
                        alert(message);
                    } else {
                        alert(`âŒ è·å–ç»Ÿè®¡å¤±è´¥: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('è·å–ç»Ÿè®¡å¤±è´¥:', error);
                    alert(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
                });
        }

</script>
</body>
</html>