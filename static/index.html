<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perplexity-2API Console</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-radius: 10px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .active { background-color: #28a745; }
        .inactive { background-color: #dc3545; }
        .api-box { background: #2d3436; color: #fff; padding: 10px; border-radius: 5px; font-family: monospace; }
        .log-container { max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .log-line { padding: 2px 5px; border-bottom: 1px solid #eee; }
        .log-line.info { color: #0d6efd; }
        .log-line.success { color: #198754; }
        .log-line.warning { color: #ffc107; }
        .log-line.error { color: #dc3545; }
        .log-line.debug { color: #6c757d; }

        .progress-bar-custom { height: 8px; }
    </style>
    <script>
        // Fix non-passive event listener warning (improves page responsiveness)
        (function() {
            var addEventListener = EventTarget.prototype.addEventListener;
            EventTarget.prototype.addEventListener = function(type, listener, options) {
                var passiveOptions = options;
                // Automatically add passive: true for scroll-related events
                if (type === 'mousewheel' || type === 'wheel' || type === 'touchstart' || type === 'touchmove') {
                    if (typeof options === 'object') {
                        passiveOptions = Object.assign({ passive: true }, options);
                    } else if (options === undefined) {
                        passiveOptions = { passive: true };
                    } else if (options === false) {
                        passiveOptions = { passive: false };
                    }
                }
                return addEventListener.call(this, type, listener, passiveOptions);
            };
        })();
    </script>
</head>
<body>
    <div class="container-fluid py-3">
        <!-- Top Navigation -->
        <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4 rounded">
            <div class="container-fluid">
                <a class="navbar-brand fw-bold text-primary" href="#">
                    <i class="fas fa-robot me-2"></i>‚ö° Perplexity-2API Console
                </a>
                <div class="d-flex">
                    <span class="badge bg-dark me-2">v3.0</span>
                    <div class="d-flex align-items-center">
                        <span class="me-2" id="systemStatus">üü¢ System Running</span>
                        <div class="spinner-border spinner-border-sm text-primary d-none" id="loadingSpinner"></div>
                    </div>
                </div>
            </div>
        </nav>

        <div class="row g-3">
            <!-- Left Sidebar -->
            <div class="col-lg-3">
                <!-- System Status Panel -->
                <div class="card p-3 mb-3">
                    <h6 class="card-title fw-bold"><i class="fas fa-heartbeat me-2"></i>System Status</h6>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">Service Status:</small>
                            <span class="badge bg-success" id="serviceStatus">Running</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">Botasaurus:</small>
                            <span class="badge bg-warning" id="botasaurusStatus">Initializing</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">Account Pool:</small>
                            <span id="accountPoolStatus">0/0</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">API Requests:</small>
                            <span id="apiRequestCount">0</span>
                        </div>
                    </div>
                    <div class="progress mb-1 progress-bar-custom">
                        <div class="progress-bar bg-info" id="memoryUsage" style="width: 30%"></div>
                    </div>
                    <small class="text-muted d-block text-center">Memory Usage: <span id="memoryText">30%</span></small>
                </div>

                <!-- Quick Actions -->
                <div class="card p-3 mb-3">
                    <h6 class="card-title fw-bold"><i class="fas fa-bolt me-2"></i>Quick Actions</h6>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-sm" id="quickLoginBtn">
                            <i class="fas fa-sign-in-alt me-1"></i> Quick Login Account
                        </button>
                        <button class="btn btn-outline-success btn-sm" id="refreshAllBtn">
                            <i class="fas fa-sync-alt me-1"></i> Refresh All Cookies
                        </button>
                        <button class="btn btn-outline-warning btn-sm" id="cleanCacheBtn">
                            <i class="fas fa-trash-alt me-1"></i> Clean Cache
                        </button>
                        <button class="btn btn-outline-info btn-sm" id="exportConfigBtn">
                            <i class="fas fa-download me-1"></i> Export Config
                        </button>
                    </div>
                </div>


                <!-- API Key Management -->
                <div class="card p-3 mb-3">
                    <h6 class="card-title fw-bold"><i class="fas fa-key me-2"></i>API Key Management</h6>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">Current API Key:</small>
                            <code class="small bg-light p-1 rounded" id="currentApiKey">Loading...</code>
                        </div>
                        <div class="input-group input-group-sm">
                            <input type="password" class="form-control" id="newApiKey" placeholder="Enter new API Key">
                            <button class="btn btn-primary" type="button" id="updateApiKeyBtn">
                                <i class="fas fa-save"></i>
                            </button>
                        </div>
                        <small class="text-muted d-block mt-2">
                            Used to authenticate client requests. Default: 1
                        </small>
                    </div>
                </div>

            </div>

            <!-- Main Content -->
            <div class="col-lg-6">
                <!-- Welcome Card -->
                <div class="card p-4 mb-4 text-center border-primary">
                    <div class="card-body">
                        <h4 class="card-title text-primary mb-3">
                            <i class="fas fa-rocket me-2"></i>Welcome to Perplexity-2API Console!
                        </h4>
                        <p class="card-text mb-3">
                            Browser login is temporarily unavailable due to advanced CAPTCHA verification that is difficult to bypass.
                        </p>
                        <div class="alert alert-info mb-4">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Please choose one of the following methods to add an account:</strong>
                        </div>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <div class="card h-100 border-success">
                                    <div class="card-body">
                                        <h5 class="card-title text-success">
                                            <i class="fas fa-sign-in-alt me-2"></i>Method 1: Quick Login
                                        </h5>
                                        <p class="card-text small">
                                            Click the button below to automatically open a browser for logging into your Perplexity account.
                                        </p>
                                        <button class="btn btn-success w-100 mt-2" id="mainQuickLoginBtn">
                                            <i class="fas fa-external-link-alt me-1"></i> Open Browser Login
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100 border-primary">
                                    <div class="card-body">
                                        <h5 class="card-title text-primary">
                                            <i class="fas fa-paste me-2"></i>Method 2: Paste Cookie
                                        </h5>
                                        <p class="card-text small">
                                            If you already have a Cookie text, you can paste it directly into the input box below.
                                        </p>
                                        <button class="btn btn-primary w-100 mt-2" type="button" data-bs-toggle="collapse" data-bs-target="#mainCookieInput">
                                            <i class="fas fa-keyboard me-1"></i> Show Cookie Input
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Cookie Input -->
                <div class="collapse show" id="mainCookieInput">
                    <div class="card p-4 mb-4">
                        <h5 class="card-title fw-bold mb-3">
                            <i class="fas fa-cookie-bite me-2"></i>Cookie Input & Parsing
                        </h5>
                        
                        <div class="alert alert-warning mb-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Supports multiple formats:</strong> HAR JSON, PowerShell, cURL, plain Cookie string
                        </div>
                        
                        <div class="mb-3">
                            <label for="mainCookieText" class="form-label fw-bold">
                                <i class="fas fa-paste me-1"></i>Paste Cookie Text
                            </label>
                            <textarea class="form-control" id="mainCookieText" rows="6"
                                      placeholder="Please paste your Cookie text...&#10;Example:&#10;pplx.visitor-id=xxx; session-token=yyy&#10;or complete HAR JSON, PowerShell format"></textarea>
                            <div class="form-text">
                                Tip: You can copy Cookie from the Network tab in browser developer tools (F12)
                            </div>
                        </div>
                        
                        <div class="row g-3 mb-3">
                            <div class="col-md-8">
                                <label for="mainAccountName" class="form-label fw-bold">
                                    <i class="fas fa-user me-1"></i>Account Name
                                </label>
                                <input type="text" class="form-control" id="mainAccountName"
                                       placeholder="Give this account a name (optional)" value="My Account">
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button class="btn btn-primary w-100" id="mainParseCookieBtn">
                                    <i class="fas fa-magic me-1"></i> Parse & Add
                                </button>
                            </div>
                        </div>
                        
                        <div class="text-center mt-3">
                            <div class="spinner-border spinner-border-sm text-primary d-none" id="mainParseSpinner"></div>
                            <div class="text-muted small" id="mainParseResult"></div>
                        </div>
                        
                        <div class="mt-4 pt-3 border-top">
                            <h6 class="fw-bold mb-2">
                                <i class="fas fa-question-circle me-2"></i>How to Get Cookie?
                            </h6>
                            <ol class="small ps-3 mb-0">
                                <li class="mb-1">Open <a href="https://www.perplexity.ai" target="_blank">Perplexity.ai</a> and log in to your account</li>
                                <li class="mb-1">Press <code>F12</code> to open developer tools</li>
                                <li class="mb-1">Switch to the <strong>Network</strong> tab</li>
                                <li class="mb-1">Refresh the page, click any request (usually <code>search</code> or <code>api</code>)</li>
                                <li class="mb-1">Find the <code>Cookie</code> field in <strong>Headers</strong></li>
                                <li>Copy the entire Cookie string and paste it into the input box above</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- Account Status Card (shown when accounts exist) -->
                <div class="card p-4 d-none" id="accountStatusCard">
                    <h5 class="card-title fw-bold mb-3">
                        <i class="fas fa-chart-line me-2"></i>Account Status Overview
                    </h5>
                    <div id="accountStatusContent">
                        <!-- Dynamically filled by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Right Sidebar -->
            <div class="col-lg-3">
                <!-- Account Management -->
                <div class="card p-3 mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="card-title fw-bold mb-0">
                            <i class="fas fa-users me-2"></i>Account Management
                            <span class="badge bg-secondary ms-2" id="accountsCount">0</span>
                        </h6>
                        <button class="btn btn-sm btn-success" id="addAccountBtn">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th>Account</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="accountsTable">
                                <tr>
                                    <td colspan="3" class="text-center text-muted py-3">
                                        Loading account list...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-2">
                        <div class="d-flex justify-content-between small">
                            <span class="text-muted">Active:</span>
                            <span class="badge bg-success" id="activeAccounts">0</span>
                        </div>
                        <div class="d-flex justify-content-between small">
                            <span class="text-muted">Inactive:</span>
                            <span class="badge bg-danger" id="inactiveAccounts">0</span>
                        </div>
                    </div>
                    
                    <!-- Cookie Import Feature -->
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-info w-100 mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#cookieImportCollapse">
                            <i class="fas fa-paste me-1"></i> Import Cookie Text
                        </button>
                        <div class="collapse" id="cookieImportCollapse">
                            <div class="border rounded p-2 bg-light">
                                <small class="text-muted d-block mb-2">
                                    Supported formats: HAR JSON, PowerShell, cURL, plain Cookie string
                                </small>
                                <textarea class="form-control form-control-sm mb-2" id="cookieText" rows="3" placeholder="Paste Cookie text..."></textarea>
                                <div class="input-group input-group-sm mb-2">
                                    <input type="text" class="form-control" id="importAccountName" placeholder="Account name (optional)" value="Imported Account">
                                    <button class="btn btn-primary" type="button" id="parseCookieBtn">
                                        <i class="fas fa-magic me-1"></i> Parse
                                    </button>
                                </div>
                                <div class="text-center small">
                                    <span class="text-muted" id="parseResult"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Model Management -->
                <div class="card p-3 mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="card-title fw-bold mb-0">
                            <i class="fas fa-robot me-2"></i>Model Management
                            <span class="badge bg-secondary ms-2" id="modelsCount">0</span>
                        </h6>
                        <button class="btn btn-sm btn-success" id="addModelBtn">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                    <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Model</th>
                                    <th>Provider</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="modelsTable">
                                <tr>
                                    <td colspan="3" class="text-center text-muted py-2">
                                        Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-2 small">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Custom:</span>
                            <span class="badge bg-info" id="customModelsCount">0</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Preset:</span>
                            <span class="badge bg-secondary" id="presetModelsCount">0</span>
                        </div>
                    </div>
                </div>

                <!-- Conversation Management -->
                <div class="card p-3 mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="card-title fw-bold mb-0">
                            <i class="fas fa-comments me-2"></i>Conversation Management
                        </h6>
                        <button class="btn btn-sm btn-outline-danger" id="resetAllConversationsBtn" title="Reset all conversations">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between small">
                            <span class="text-muted">Active Conversations:</span>
                            <span class="badge bg-info" id="activeConversations">0</span>
                        </div>
                        <div class="d-flex justify-content-between small">
                            <span class="text-muted">Max Turns:</span>
                            <span id="maxTurnsPerConv">50</span>
                        </div>
                        <div class="d-flex justify-content-between small">
                            <span class="text-muted">Max Conversations:</span>
                            <span id="maxConversations">10</span>
                        </div>
                    </div>
                    <div class="mt-2" id="conversationsList" style="max-height: 150px; overflow-y: auto;">
                        <div class="text-center text-muted small py-2">
                            No active conversations
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted d-block">
                            <i class="fas fa-info-circle me-1"></i>
                            Each conversation has a maximum of 50 turns, after which a new conversation is automatically created
                        </small>
                    </div>
                </div>

                <!-- API Endpoints -->
                <div class="card p-3 mb-3">
                    <h6 class="card-title fw-bold"><i class="fas fa-code me-2"></i>API Endpoints</h6>
                    <div class="mb-2">
                        <div class="api-box mb-1">
                            <small class="text-info">POST</small> /v1/chat/completions
                        </div>
                        <div class="api-box mb-1">
                            <small class="text-info">GET</small> /v1/models
                        </div>
                        <div class="api-box mb-1">
                            <small class="text-info">GET</small> /api/system/status
                        </div>
                        <div class="api-box mb-1">
                            <small class="text-info">GET</small> /api/conversations
                        </div>
                        <div class="api-box">
                            <small class="text-info">POST</small> /api/conversations/reset
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">API Key:</small>
                        <code class="small d-block bg-light p-1 rounded">1 (or configured in .env)</code>
                    </div>
                </div>

                <!-- System Information -->
                <div class="card p-3">
                    <h6 class="card-title fw-bold"><i class="fas fa-info-circle me-2"></i>System Information</h6>
                    <div class="small">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Version:</span>
                            <span>v3.0</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Uptime:</span>
                            <span id="uptime">--</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Python:</span>
                            <span id="pythonVersion">--</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Host:</span>
                            <span id="hostName">--</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Working Dir:</span>
                            <span class="text-truncate" style="max-width: 150px;" id="workingDir">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer Status Bar -->
        <footer class="mt-4 pt-3 border-top">
            <div class="row">
                <div class="col-md-8">
                    <small class="text-muted">
                        <i class="fas fa-exclamation-circle me-1"></i>
                        Tip: Click "Quick Login Account" to open https://www.perplexity.ai/ in browser, cookies will be automatically saved after login
                    </small>
                </div>
                <div class="col-md-4 text-end">
                    <small class="text-muted" id="lastUpdate">
                        Last Update: <span id="updateTime">--</span>
                    </small>
                </div>
            </div>
        </footer>
    </div>

    <!-- JavaScript -->
    <script>
        // Global state
        let systemState = {
            logs: [],
            files: [],
            accounts: [],
            selectedFiles: new Set(),
            isLogPaused: false,
            autoScroll: true,
            logFilters: {
                info: true,
                warning: true,
                error: true,
                debug: false
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
            loadAllData();
            startLiveUpdates();
        });

        // System initialization
        function initializeSystem() {
            // Update system information
            fetch('/api/system/info')
                .then(res => res.json())
                .then(data => {
                    if (data.python_version) {
                        document.getElementById('pythonVersion').textContent = data.python_version;
                    }
                    if (data.host_name) {
                        document.getElementById('hostName').textContent = data.host_name;
                    }
                    if (data.working_dir) {
                        document.getElementById('workingDir').textContent = data.working_dir;
                    }
                    if (data.uptime) {
                        document.getElementById('uptime').textContent = data.uptime;
                    }
                })
                .catch(console.error);

            // Update last update time
            updateTime();
            setInterval(updateTime, 60000); // Update every minute
        }

        // Update current time
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US');
            document.getElementById('updateTime').textContent = timeStr;
        }

        // Load all data
        function loadAllData() {
            loadSystemStatus();
            loadAccounts();
            loadLogs();
            loadApiKey();
            loadModels();
            loadConversations();
        }

        // Load system status
        function loadSystemStatus() {
            fetch('/api/system/status')
                .then(res => res.json())
                .then(data => {
                    // Update status indicators
                    if (data.service_status === 'running') {
                        document.getElementById('serviceStatus').className = 'badge bg-success';
                        document.getElementById('serviceStatus').textContent = 'Running';
                        document.getElementById('systemStatus').innerHTML = 'üü¢ System Running';
                    } else {
                        document.getElementById('serviceStatus').className = 'badge bg-danger';
                        document.getElementById('serviceStatus').textContent = 'Stopped';
                        document.getElementById('systemStatus').innerHTML = 'üî¥ System Error';
                    }

                    // Update Botasaurus status
                    if (data.botasaurus_status === 'initialized') {
                        document.getElementById('botasaurusStatus').className = 'badge bg-success';
                        document.getElementById('botasaurusStatus').textContent = 'Ready';
                    } else if (data.botasaurus_status === 'initializing') {
                        document.getElementById('botasaurusStatus').className = 'badge bg-warning';
                        document.getElementById('botasaurusStatus').textContent = 'Initializing';
                    } else {
                        document.getElementById('botasaurusStatus').className = 'badge bg-danger';
                        document.getElementById('botasaurusStatus').textContent = 'Failed';
                    }

                    // Update account pool status
                    document.getElementById('accountPoolStatus').textContent =
                        `${data.active_accounts || 0}/${data.total_accounts || 0}`;
                    
                    // Update API request count
                    document.getElementById('apiRequestCount').textContent = data.api_requests || 0;

                    // Update memory usage
                    if (data.memory_usage) {
                        const memoryPercent = Math.min(100, Math.max(0, data.memory_usage));
                        document.getElementById('memoryUsage').style.width = `${memoryPercent}%`;
                        document.getElementById('memoryText').textContent = `${memoryPercent}%`;
                    }
                })
                .catch(console.error);
        }

        // Load accounts list
        function loadAccounts() {
            fetch('/api/accounts')
                .then(res => res.json())
                .then(data => {
                    systemState.accounts = data.accounts || [];
                    updateAccountsTable();
                    
                    // Update counts
                    document.getElementById('accountsCount').textContent = systemState.accounts.length;
                    const active = systemState.accounts.filter(a => a.is_active).length;
                    const inactive = systemState.accounts.length - active;
                    document.getElementById('activeAccounts').textContent = active;
                    document.getElementById('inactiveAccounts').textContent = inactive;
                    
                    // Update UI state (show/hide welcome card)
                    updateUIState();
                })
                .catch(console.error);
        }

        // Update accounts table
        function updateAccountsTable() {
            const tbody = document.getElementById('accountsTable');
            if (systemState.accounts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted py-3">
                            No accounts, click "Add" button to create
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            systemState.accounts.slice(0, 5).forEach(account => {
                const statusClass = account.is_active ? 
                    (account.token && account.token.length > 20 ? 'success' : 'warning') : 'secondary';
                const statusIcon = account.is_active ? 
                    (account.token && account.token.length > 20 ? '‚úÖ' : '‚ö†Ô∏è') : '‚è∏Ô∏è';
                
                html += `
                    <tr>
                        <td>
                            <span class="badge bg-${statusClass}">${statusIcon}</span>
                        </td>
                        <td>
                            <div class="small">${account.name || 'Unnamed'}</div>
                            <div class="text-muted" style="font-size: 10px;">${account.data_dir || ''}</div>
                            <div class="text-muted" style="font-size: 9px;">Cookie: ${account.cookie_count || 0}</div>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshAccount('${account.id}')" title="Âà∑Êñ∞">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success mt-1" onclick="verifyAccount('${account.name}')" title="È™åËØÅCookie">
                                <i class="fas fa-check-circle"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            if (systemState.accounts.length > 5) {
                html += `
                    <tr>
                        <td colspan="4" class="text-center">
                            <small class="text-muted">
                                ${systemState.accounts.length - 5} more accounts...
                            </small>
                        </td>
                    </tr>
                `;
            }

            tbody.innerHTML = html;
        }



        // Update UI state (show/hide welcome card)
        function updateUIState() {
            const hasAccounts = systemState.accounts.length > 0;
            const welcomeCard = document.querySelector('#mainCookieInput');
            const statusCard = document.getElementById('accountStatusCard');
            
            if (hasAccounts) {
                // Has accounts: hide welcome card, show account status overview
                welcomeCard?.classList.add('d-none');
                if (statusCard) {
                    statusCard.classList.remove('d-none');
                    // Fill account status content
                    const activeCount = systemState.accounts.filter(a => a.is_active).length;
                    const inactiveCount = systemState.accounts.length - activeCount;
                    const totalCalls = systemState.accounts.reduce((sum, acc) => sum + (acc.total_calls || 0), 0);
                    
                    document.getElementById('accountStatusContent').innerHTML = `
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h3 class="card-title">${systemState.accounts.length}</h3>
                                        <p class="card-text small">Total Accounts</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h3 class="card-title">${activeCount}</h3>
                                        <p class="card-text small">Active Accounts</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h3 class="card-title">${totalCalls}</h3>
                                        <p class="card-text small">Total Calls</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } else {
                // No accounts: show welcome card and Cookie input, hide status card
                welcomeCard?.classList.remove('d-none');
                statusCard?.classList.add('d-none');
            }
        }

        // Update file tree


        // Load logs
        function loadLogs() {
            fetch('/api/logs/recent')
                .then(res => res.json())
                .then(data => {
                    systemState.logs = data.logs || [];
                    updateLiveLogs();
                    document.getElementById('logCount').textContent = systemState.logs.length;
                })
                .catch(console.error);
        }

        // Load API Key
        function loadApiKey() {
            fetch('/api/settings/api-key')
                .then(res => res.json())
                .then(data => {
                    const masked = data.masked || '***';
                    document.getElementById('currentApiKey').textContent = masked;
                })
                .catch(console.error);
        }

        // Load models list
        function loadModels() {
            fetch('/api/models')
                .then(res => res.json())
                .then(data => {
                    const models = data.models || [];
                    const customModels = models.filter(m => m.is_custom);
                    const presetModels = models.filter(m => !m.is_custom);
                    
                    document.getElementById('modelsCount').textContent = models.length;
                    document.getElementById('customModelsCount').textContent = customModels.length;
                    document.getElementById('presetModelsCount').textContent = presetModels.length;
                    
                    // Update table
                    const tbody = document.getElementById('modelsTable');
                    if (models.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="3" class="text-center text-muted py-2">
                                    No models
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    let html = '';
                    models.slice(0, 10).forEach(model => {
                        const isCustom = model.is_custom || false;
                        const canDelete = model.can_delete !== false && isCustom;
                        const canRename = model.can_rename !== false && isCustom;
                        const modelName = model.name || model.id;
                        const modelId = model.id;
                        const provider = model.provider || 'Unknown';
                        
                        html += `
                            <tr>
                                <td>
                                    <div class="small fw-bold">${modelName}</div>
                                    <div class="text-muted" style="font-size: 10px;">
                                        <code>${modelId}</code>
                                        <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyModelId('${modelId}')" title="Copy Model ID">
                                            <i class="fas fa-copy" style="font-size: 10px;"></i>
                                        </button>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-${isCustom ? 'info' : 'secondary'}">
                                        ${provider}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="copyModelName('${modelName}')" title="Copy Model Name">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    ${canRename ? `
                                    <button class="btn btn-sm btn-outline-primary" onclick="renameModel('${modelId}')" title="Rename">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    ` : ''}
                                    ${canDelete ? `
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteModel('${modelId}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    ` : ''}
                                </td>
                            </tr>
                        `;
                    });
                    
                    if (models.length > 10) {
                        html += `
                            <tr>
                                <td colspan="3" class="text-center">
                                    <small class="text-muted">
                                        ${models.length - 10} more models...
                                    </small>
                                </td>
                            </tr>
                        `;
                    }
                    
                    tbody.innerHTML = html;
                })
                .catch(console.error);
        }

        // Load conversations list
        function loadConversations() {
            fetch('/api/conversations')
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.stats) {
                        const stats = data.stats;
                        
                        // Update statistics
                        document.getElementById('activeConversations').textContent = stats.active_conversations || 0;
                        document.getElementById('maxTurnsPerConv').textContent = stats.max_turns_per_conversation || 50;
                        document.getElementById('maxConversations').textContent = stats.max_conversations || 10;
                        
                        // Update conversations list
                        const listContainer = document.getElementById('conversationsList');
                        const conversations = stats.conversations || {};
                        const convIds = Object.keys(conversations);
                        
                        if (convIds.length === 0) {
                            listContainer.innerHTML = `
                                <div class="text-center text-muted small py-2">
                                    No active conversations
                                </div>
                            `;
                        } else {
                            let html = '';
                            convIds.forEach(cid => {
                                const conv = conversations[cid];
                                const turnCount = conv.turn_count || 0;
                                const maxTurns = stats.max_turns_per_conversation || 50;
                                const progress = Math.min(100, (turnCount / maxTurns) * 100);
                                const progressColor = progress > 80 ? 'danger' : progress > 50 ? 'warning' : 'success';
                                
                                html += `
                                    <div class="border rounded p-2 mb-2 bg-light">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="fw-bold text-truncate" style="max-width: 100px;" title="${cid}">${cid}</small>
                                            <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="resetConversation('${cid}')" title="Reset this conversation">
                                                <i class="fas fa-times" style="font-size: 10px;"></i>
                                            </button>
                                        </div>
                                        <div class="progress mt-1" style="height: 4px;">
                                            <div class="progress-bar bg-${progressColor}" style="width: ${progress}%"></div>
                                        </div>
                                        <div class="d-flex justify-content-between mt-1">
                                            <small class="text-muted" style="font-size: 10px;">Turns: ${turnCount}/${maxTurns}</small>
                                            <small class="text-muted" style="font-size: 10px;">${conv.has_backend_uuid ? '‚úÖ' : 'üÜï'}</small>
                                        </div>
                                    </div>
                                `;
                            });
                            listContainer.innerHTML = html;
                        }
                    }
                })
                .catch(err => {
                    console.error('Failed to load conversations:', err);
                });
        }

        // Reset single conversation
        function resetConversation(conversationId) {
            if (!confirm(`Are you sure you want to reset conversation "${conversationId}"?\n\nThis will clear the conversation's context memory.`)) {
                return;
            }
            
            fetch('/api/conversations/reset', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ conversation_id: conversationId })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast(`‚úÖ Conversation "${conversationId}" has been reset`, 'success');
                    loadConversations();
                } else {
                    alert(`‚ùå Reset failed: ${data.message}`);
                }
            })
            .catch(err => {
                alert(`‚ùå Request failed: ${err.message}`);
            });
        }

        // Reset all conversations
        function resetAllConversations() {
            if (!confirm('Are you sure you want to reset all conversations?\n\nThis will clear the context memory of all conversations.')) {
                return;
            }
            
            fetch('/api/conversations/reset-all', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    loadConversations();
                } else {
                    alert(`‚ùå Reset failed: ${data.message}`);
                }
            })
            .catch(err => {
                alert(`‚ùå Request failed: ${err.message}`);
            });
        }

        // Export as global functions
        window.resetConversation = resetConversation;
        window.resetAllConversations = resetAllConversations;

        // Update live logs
        function updateLiveLogs() {
            if (systemState.isLogPaused) return;
            
            const container = document.getElementById('liveLogs');
            let html = '';
            
            systemState.logs.slice(-50).forEach(log => {
                const level = log.level || 'info';
                if (!systemState.logFilters[level]) return;
                
                const time = log.timestamp ? log.timestamp.split(' ')[1] : '--:--:--';
                const message = log.message || '';
                
                html += `
                    <div class="log-line ${level}">
                        <span class="text-muted">[${time}]</span> ${message}
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Auto-scroll to bottom
            if (systemState.autoScroll) {
                container.scrollTop = container.scrollHeight;
            }
        }

        // Update storage info


        // Start live updates
        function startLiveUpdates() {
            // Page visibility detection: pause polling when page is hidden
            let isPageVisible = true;
            document.addEventListener('visibilitychange', function() {
                isPageVisible = !document.hidden;
            });
            
            // System status updates every 30 seconds (when page is visible)
            setInterval(() => {
                if (isPageVisible) loadSystemStatus();
            }, 30000);
            
            // Accounts update every 120 seconds (when page is visible)
            setInterval(() => {
                if (isPageVisible) loadAccounts();
            }, 120000);
            
            // Logs update every 30 seconds (when page is visible)
            setInterval(() => {
                if (isPageVisible) loadLogs();
            }, 30000);
            
            // Conversations update every 15 seconds (when page is visible)
            setInterval(() => {
                if (isPageVisible) loadConversations();
            }, 15000);
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // Event listener setup (enhanced: safety checks)
        function setupEventListeners() {
            // Safety check helper function
            function safeAddEventListener(id, event, handler) {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener(event, handler);
                } else {
                    console.warn(`‚ö†Ô∏è Element #${id} does not exist, skipping event binding`);
                }
            }
            
            // Safe query selector
            function safeQuerySelectorAll(selector, handler) {
                const elements = document.querySelectorAll(selector);
                if (elements.length > 0) {
                    elements.forEach(el => {
                        el.addEventListener('change', handler);
                    });
                } else {
                    console.warn(`‚ö†Ô∏è Selector ${selector} found no elements, skipping event binding`);
                }
            }

            // Auto-scroll (if element exists)
            safeAddEventListener('autoScroll', 'change', function(e) {
                systemState.autoScroll = e.target.checked;
            });

            // Log level filtering (if element exists)
            safeQuerySelectorAll('.log-level', function(e) {
                const level = e.target.id.replace('show', '').toLowerCase();
                systemState.logFilters[level] = e.target.checked;
                updateLiveLogs();
            });

            // Pause logs (if element exists)
            safeAddEventListener('pauseLogsBtn', 'click', function() {
                systemState.isLogPaused = !systemState.isLogPaused;
                const icon = this.querySelector('i');
                if (systemState.isLogPaused) {
                    icon.className = 'fas fa-play';
                    this.title = 'Resume logs';
                } else {
                    icon.className = 'fas fa-pause';
                    this.title = 'Pause logs';
                    updateLiveLogs();
                }
            });

            // Clear logs (if element exists)
            safeAddEventListener('clearLogsBtn', 'click', function() {
                if (confirm('Are you sure you want to clear all logs?')) {
                    fetch('/api/logs/clear', { method: 'POST' })
                        .then(() => {
                            systemState.logs = [];
                            updateLiveLogs();
                        })
                        .catch(console.error);
                }
            });

            // Quick login
            safeAddEventListener('quickLoginBtn', 'click', function() {
                const accountName = prompt('Please enter account name (optional):', 'New Account');
                if (accountName === null) return;
                
                fetch('/api/account/login/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `name=${encodeURIComponent(accountName || 'New Account')}`
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert(`‚úÖ Login process started\n\nPlease log in at https://www.perplexity.ai/ in the opened browser\nCookies will be automatically saved after successful login.`);
                        loadAccounts();
                    } else {
                        alert(`‚ùå Start failed: ${data.message}`);
                    }
                })
                .catch(err => {
                    alert(`‚ùå Error: ${err.message}`);
                });
            });

            // Refresh all cookies
            safeAddEventListener('refreshAllBtn', 'click', function() {
                if (confirm('Are you sure you want to refresh all account cookies?')) {
                    fetch('/api/accounts/refresh-all', { method: 'POST' })
                        .then(res => res.json())
                        .then(data => {
                            alert(data.message || 'Refresh request sent');
                            loadAccounts();
                        })
                        .catch(console.error);
                }
            });

            // Reset all conversations button
            safeAddEventListener('resetAllConversationsBtn', 'click', function() {
                resetAllConversations();
            });

            // Clean cache
            safeAddEventListener('cleanCacheBtn', 'click', function() {
                if (confirm('Are you sure you want to clean all cache files?\n\nThis will delete temporary files but keep account data.')) {
                    fetch('/api/files/clean-cache', { method: 'POST' })
                        .then(res => res.json())
                        .then(data => {
                            alert(data.message || 'Cache cleaning completed');
                        })
                        .catch(console.error);
                }
            });

            // Export config (new)
            safeAddEventListener('exportConfigBtn', 'click', function() {
                fetch('/api/settings/export-config', { method: 'GET' })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            // Create download link
                            const blob = new Blob([JSON.stringify(data.config, null, 2)], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `perplexity-config-${new Date().toISOString().slice(0,10)}.json`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                            
                            showToast('‚úÖ Config exported successfully!', 'success');
                        } else {
                            alert(`‚ùå Export failed: ${data.message || 'Unknown error'}`);
                        }
                    })
                    .catch(err => {
                        console.error('Export config failed:', err);
                        // Temporary implementation: show success message (simulated)
                        showToast('‚úÖ Config export feature in development, current version saves all configs to local directory', 'info');
                    });
            });

            // Add account button
            safeAddEventListener('addAccountBtn', 'click', function() {
                document.getElementById('quickLoginBtn')?.click();
            });

            // Cookie parse button
            safeAddEventListener('parseCookieBtn', 'click', function() {
                const cookieText = document.getElementById('cookieText')?.value.trim();
                const accountName = document.getElementById('importAccountName')?.value.trim() || 'Imported Account';
                
                if (!cookieText) {
                    alert('Please paste Cookie text first');
                    return;
                }
                
                const resultElem = document.getElementById('parseResult');
                if (resultElem) {
                    resultElem.textContent = 'Parsing...';
                    resultElem.className = 'text-muted';
                }
                
                fetch('/api/cookie/parse', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: cookieText,
                        account_name: accountName
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (resultElem) {
                        if (data.success) {
                            resultElem.textContent = `‚úÖ ${data.message}`;
                            resultElem.className = 'text-success';
                            
                            // Clear text area
                            const cookieTextArea = document.getElementById('cookieText');
                            if (cookieTextArea) cookieTextArea.value = '';
                            
                            // Update accounts list
                            loadAccounts();
                            
                            // Hide result after 3 seconds
                            setTimeout(() => {
                                resultElem.textContent = '';
                            }, 3000);
                        } else {
                            resultElem.textContent = `‚ùå ${data.message}`;
                            resultElem.className = 'text-danger';
                        }
                    }
                })
                .catch(err => {
                    if (resultElem) {
                        resultElem.textContent = `‚ùå Request failed: ${err.message}`;
                        resultElem.className = 'text-danger';
                    }
                });
            });

            // API Key update
            safeAddEventListener('updateApiKeyBtn', 'click', function() {
                const newKey = document.getElementById('newApiKey')?.value.trim();
                if (!newKey) {
                    alert('Please enter a new API Key');
                    return;
                }
                
                if (!confirm('Are you sure you want to update the API Key?\n\nPlease note that some features may require a service restart to take effect.')) {
                    return;
                }
                
                fetch('/api/settings/api-key', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ api_key: newKey })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message || '‚úÖ API Key updated successfully');
                        const newKeyInput = document.getElementById('newApiKey');
                        if (newKeyInput) newKeyInput.value = '';
                        loadApiKey();
                    } else {
                        alert('‚ùå Update failed: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(err => {
                    alert('‚ùå Request failed: ' + err.message);
                });
            });

            // Main area quick login button
            safeAddEventListener('mainQuickLoginBtn', 'click', function() {
                const accountName = prompt('Please enter account name (optional):', 'New Account');
                if (accountName === null) return;
                
                fetch('/api/account/login/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `name=${encodeURIComponent(accountName || 'New Account')}`
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert(`‚úÖ Login process started\n\nPlease log in at https://www.perplexity.ai/ in the opened browser\nCookies will be automatically saved after successful login.`);
                        loadAccounts();
                    } else {
                        alert(`‚ùå Start failed: ${data.message}`);
                    }
                })
                .catch(err => {
                    alert(`‚ùå Error: ${err.message}`);
                });
            });

            // Main area Cookie parse button
            safeAddEventListener('mainParseCookieBtn', 'click', function() {
                const cookieText = document.getElementById('mainCookieText')?.value.trim();
                const accountName = document.getElementById('mainAccountName')?.value.trim() || 'My Account';
                
                if (!cookieText) {
                    alert('Please paste Cookie text first');
                    return;
                }
                
                const spinner = document.getElementById('mainParseSpinner');
                const resultElem = document.getElementById('mainParseResult');
                
                if (spinner) spinner.classList.remove('d-none');
                if (resultElem) {
                    resultElem.textContent = 'Parsing Cookie...';
                    resultElem.className = 'text-muted';
                }
                
                fetch('/api/cookie/parse', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: cookieText,
                        account_name: accountName
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (spinner) spinner.classList.add('d-none');
                    
                    if (resultElem) {
                        if (data.success) {
                            resultElem.textContent = `‚úÖ ${data.message}`;
                            resultElem.className = 'text-success';
                            
                            // Clear text area
                            const mainCookieText = document.getElementById('mainCookieText');
                            if (mainCookieText) mainCookieText.value = '';
                            
                            // Update accounts list
                            loadAccounts();
                            
                            // Clear result after 5 seconds
                            setTimeout(() => {
                                resultElem.textContent = '';
                            }, 5000);
                        } else {
                            resultElem.textContent = `‚ùå ${data.message}`;
                            resultElem.className = 'text-danger';
                        }
                    }
                })
                .catch(err => {
                    if (spinner) spinner.classList.add('d-none');
                    if (resultElem) {
                        resultElem.textContent = `‚ùå Request failed: ${err.message}`;
                        resultElem.className = 'text-danger';
                    }
                });
            });

            // Add model button
            safeAddEventListener('addModelBtn', 'click', function() {
                addModel();
            });

            console.log('‚úÖ Event listeners initialized');
        }

        // Initialize event listeners
        setupEventListeners();

        // Helper functions
        function showToast(message, type = 'info') {
            // Create or get toast container
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.style.cssText = 'position:fixed;top:20px;right:20px;z-index:9999;max-width:400px;';
                document.body.appendChild(container);
            }
            
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} alert-dismissible fade show`;
            toast.style.cssText = 'margin-bottom:10px;box-shadow:0 4px 12px rgba(0,0,0,0.15);min-width:300px;';
            toast.innerHTML = `
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                ${message}
            `;
            
            container.appendChild(toast);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }
        
        function refreshAccount(accountId) {
            fetch(`/api/account/refresh/${accountId}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    alert(data.message || 'Refresh completed');
                    loadAccounts();
                })
                .catch(console.error);
        }

        // Export as global functions
        window.refreshAccount = refreshAccount;
        window.verifyAccount = verifyAccount;
        window.triggerMaintenance = triggerMaintenance;
        window.viewAccountStats = viewAccountStats;
        
        // Model management functions
        function copyModelId(modelId) {
            navigator.clipboard.writeText(modelId).then(() => {
                showToast('‚úÖ Model ID copied to clipboard: ' + modelId, 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('‚ùå Copy failed, please copy manually: ' + modelId);
            });
        }
        
        function copyModelName(modelName) {
            navigator.clipboard.writeText(modelName).then(() => {
                showToast('‚úÖ Model name copied to clipboard: ' + modelName, 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('‚ùå Copy failed, please copy manually: ' + modelName);
            });
        }
        
        function renameModel(modelId) {
            const newName = prompt(`Please enter the new name for the model:\n\nCurrent model ID: ${modelId}`, '');
            if (newName === null || newName.trim() === '') return;
            
            fetch(`/api/models/${encodeURIComponent(modelId)}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: newName.trim() })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    loadModels();
                } else {
                    alert(`‚ùå Rename failed: ${data.message || 'Unknown error'}`);
                }
            })
            .catch(error => {
                console.error('Rename failed:', error);
                alert(`‚ùå Request failed: ${error.message}`);
            });
        }
        
        function deleteModel(modelId) {
            if (!confirm(`Are you sure you want to delete this model?\n\nModel ID: ${modelId}\n\nThis action cannot be undone.`)) {
                return;
            }
            
            fetch(`/api/models/${encodeURIComponent(modelId)}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    loadModels();
                } else {
                    alert(`‚ùå Delete failed: ${data.message || 'Unknown error'}`);
                }
            })
            .catch(error => {
                console.error('Delete failed:', error);
                alert(`‚ùå Request failed: ${error.message}`);
            });
        }
        
        // Add model function
        function addModel() {
            const modelId = prompt('Please enter model ID (must be unique, e.g.: my-model):', '');
            if (!modelId || modelId.trim() === '') return;
            
            const modelName = prompt('Please enter model display name (optional):', modelId);
            if (modelName === null) return;
            
            const provider = prompt('Please enter model provider (optional, e.g.: openai, anthropic, custom):', 'custom');
            if (provider === null) return;
            
            fetch('/api/models', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: modelId.trim(),
                    name: modelName.trim() || modelId.trim(),
                    provider: provider.trim() || 'custom'
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    loadModels();
                } else {
                    alert(`‚ùå Add failed: ${data.message || 'Unknown error'}`);
                }
            })
            .catch(error => {
                console.error('Add model failed:', error);
                alert(`‚ùå Request failed: ${error.message}`);
            });
        }
        
        // Export as global functions
        window.copyModelId = copyModelId;
        window.copyModelName = copyModelName;
        window.renameModel = renameModel;
        window.deleteModel = deleteModel;
        window.addModel = addModel;
        
        // Verify account Cookie
        function verifyAccount(accountName) {
            const button = event.target.closest('button');
            const originalHtml = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            button.disabled = true;
            
            fetch(`/api/account/verify/${encodeURIComponent(accountName)}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert(`‚úÖ Verification successful!\n\nAccount: ${accountName}\nStatus: ${data.message}\nCookie count: ${data.cookie_count || 'Unknown'}`);
                    // Reload accounts list
                    loadAccounts();
                } else {
                    alert(`‚ùå Verification failed!\n\nAccount: ${accountName}\nError: ${data.message || 'Unknown error'}`);
                }
            })
            .catch(error => {
                console.error('Verification failed:', error);
                alert(`‚ùå Verification request failed: ${error.message}`);
            })
            .finally(() => {
                button.innerHTML = originalHtml;
                button.disabled = false;
            });
        }

        // Trigger account maintenance
        function triggerMaintenance(accountName) {
            if (!confirm(`Are you sure you want to trigger automatic maintenance for ${accountName}?\n\nThis will force refresh cookies and may take a few minutes.`)) {
                return;
            }
            
            fetch(`/api/account/maintenance/${encodeURIComponent(accountName)}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert(`‚úÖ Maintenance triggered!\n\n${data.message}`);
                } else {
                    alert(`‚ùå Maintenance trigger failed: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('Maintenance trigger failed:', error);
                alert(`‚ùå Request failed: ${error.message}`);
            });
        }

        // View account statistics
        function viewAccountStats(accountName) {
            fetch(`/api/account/stats/${encodeURIComponent(accountName)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const stats = data.summary;
                        const message = `üìä Account Statistics: ${accountName}\n\n` +
                                      `Total calls: ${stats.total_calls}\n` +
                                      `Successful calls: ${stats.success_calls}\n` +
                                      `Failed calls: ${stats.failed_calls}\n` +
                                      `Success rate: ${stats.success_rate.toFixed(1)}%\n` +
                                      `Consecutive failures: ${stats.consecutive_failures}\n` +
                                      `Last success: ${stats.last_success ? new Date(stats.last_success * 1000).toLocaleString() : 'None'}\n` +
                                      `Last failure: ${stats.last_failure ? new Date(stats.last_failure * 1000).toLocaleString() : 'None'}`;
                        alert(message);
                    } else {
                        alert(`‚ùå Failed to get statistics: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Failed to get statistics:', error);
                    alert(`‚ùå Request failed: ${error.message}`);
                });
        }

</script>
</body>
</html>